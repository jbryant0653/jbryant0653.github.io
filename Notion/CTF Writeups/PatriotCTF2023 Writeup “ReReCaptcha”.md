#writeups/crypto #writeups/2023 #writeups/PatriotCTF #writeups/Easy
# Investigation/Code Review
[https://github.com/MasonCompetitiveCyber/PatriotCTF2023/tree/main/Crypto/ReReCaptcha](https://github.com/MasonCompetitiveCyber/PatriotCTF2023/tree/main/Crypto/ReReCaptcha)
* In this challenge, we were given a <font color="#ff0000">zip file</font> and some images in the zip file as stated in the challenge description.

--- start-multi-column: ID_rlj2

```column-settings
Number of Columns: 1
Largest Column: Full
Column Position: Center
Alignment: Center
Border: off
Content Overflow: Scroll
```

![[Untitled 2.png|Untitled 2.png|400]] 

--- end-multi-column
# Challenge description

* Let's begin by unzipping the items in the .zip file and looking at them. I used the <font color="#ff0000">unzip command </font>in Linux but you can also use a web unzip tool such as: (https://www.ezyzip.com/unzip-files-online.html).  

--- start-multi-column: ID_9jti
```column-settings
Number of Columns: 1
Largest Column: standard
Col Size: Full
```

![[Untitled 1.png|]]

--- end-multi-column

* As you can see we get the images <font color="#ff0000">CT.png, E.png, P.png, Q.png</font>. Let's take a look at what these images look like!  

--- start-multi-column: ID_lwss
```column-settings
Number of Columns: 2
Largest Column: Standard
Column Position: Center
Alignment: Center
Border: off
Content Overflow: Scroll
```

![[Untitled 2 2.png|Untitled 2 2.png]]

CT.png

![[Untitled 3.png]]

E.png

--- column-break ---

![[Untitled 4.png]]

P.png

![[Untitled 5.png]]

Q.png

--- end-multi-column

> [!hint]-  
> We see that we have 3 very large numbers and 1 small number E. I can see from experience that this is obviously <font color="#ff0000">RSA Encryption</font>. But what if you didn’t know it was RSA Encryption, we can do some basic googling to see what we get. Something like googling <font color="#ff0000">“cryptography p q e ct”</font> will get you this result:  
> ![[Untitled 6.png]]

> [!research]-
> After reading you can tell these numbers are for RSA Encryption. Let's look up RSA Encryption and understand how it works(https://en.wikipedia.org/wiki/RSA_(cryptosystem)). Another great resource to understand things simply is (https://chat.openai.com/). Which explains things this way: 
> ![[Untitled 7.png]]

* Based on what we have read above we know we must decrypt their message and we know that we should be able to because chatgpt said <font color="#ff0000">The security of RSA relies on the difficulty of factoring the product n into its prime factors p and q.</font> We are given <font color="#ff0000">p</font> and <font color="#ff0000">q</font> so we should be able to decrypt <font color="#ff0000">CT</font>.  

# Decryption

> [!question]  
> Let's ask ourselves some basic questions about how the decryption works. We start with <font color="#ff0000">$M = (C^d) \mod n$</font>. 
> * We want to get M on the left and need what's on the right to get it. Let’s list what we don’t have and what we do have below:  

--- start-multi-column: ID_7gi3
```column-settings
Number of Columns: 2
Largest Column: standard
Border: off
```

<u>**What We Have:**</u>

- C
- p
- q
- e

--- column-break ---

<u>**What We Don’t Have (But need):**</u>

- M
- n
- d

--- end-multi-column
  
---

> [!important]  
> * Based on what we now know, n can be solved using p and q via this formula: <font color="#ff0000">$n=p*q$</font>. 
> * We are still missing d though? Again if we look at what chatgpt said, d is generated using this formula: <font color="#ff0000">$(d \cdot e)\mod\phi(n)$</font>﻿. 
> 	* This is called the modular multiplicative inverse which solves for d. It can also be written as ﻿<font color="#ff0000">$(d \cdot e) \equiv 1 \pmod{\phi(n)}$</font>. 
> 	* If you want to know more about modulus, modulo congruence, or modular multiplicative inverse, then check out Kahn academy’s amazing resource on this: (https://www.khanacademy.org/computing/computer-science/cryptography/modarithmetic/a/what-is-modular-arithmetic).  
  
* The important part to note from the resources on modular multiplicative inverse is that to solve for d you need to use the <font color="#ff0000">Extended Euclidean Algorithm</font> which basically solves for the <font color="#ff0000">Greatest Common Divisor</font> between 2 values. In this case, the values would be <font color="#ff0000">e</font> and <font color="#ff0000">φ(n)</font>, and the GCD would be <font color="#ff0000">d</font>. There are usually libraries that can do this for you!!  
* We now have a new unknown: <font color="#ff0000">φ(n)</font>. To solve for it we can look at chatgpt again to see that we can use p and q to find it: <font color="#ff0000">$\phi(n) = (p-1)(q-1)$</font>﻿.  

---

# Solution
* We now know what we have to do to solve this challenge. Basically a bunch of math which computers are really good at. But we need the right tools for the job! <font color="#ff0000">Python</font> works great for these crypto challenges because it is easy to use but also python is one of the few programming languages that can handle arithmetic with such large numbers. Thankfully there is a free open-source math software called <font color="#ff0000">SageMath</font>(https://www.sagemath.org/) which is written in Python and uses most of the libraries such as <font color="#ff0000">Numpy</font> which allow Python to handle such large numbers. It is also important to use <font color="#ff0000">PyCryptodome</font> Library (https://pycryptodome.readthedocs.io/en/latest/#) to easily do basic functions for Crypto such as Modulo inverse and conversions.  
  
> [!important]  
> Even better! Sagemath has partnered with <font color="#ff0000">CoCalc</font> which is a platform to save, share, and work together with others on programs and math work together. CoCalc has <font color="#ff0000">ChatGPT, Matlab, and Sagemath</font> all integrated into one online platform! Great for Crypto and for doing math.  

---

> [!danger]- Issue
> * We have one issue though, how are we gonna get the numbers from the images to do the math? 
>> [!research]
>> * With some quick googling, you can find web tools that can extract the text from an image, such as: (https://www.imagetotext.info/). 
> * After Getting the text you realize that the converter includes newlines when the text reaches the end of the image. 
> * This causes the value to not be one number but many numbers. 
>>[!research] 
>>* To fix this we can also use an online web tool such as: (https://www.browserling.com/tools/remove-all-whitespace) to get rid of all newlines and whitespace. 
>* After doing this we can begin creating the solution by creating our variables for RSA in SageMath.  

1. Import <font color="#ff0000">Crypto Libraries</font> and <font color="#ff0000">Add variables</font> to store the large numbers. Note: The numbers below have newlines added to them to fit on the screen. You will need to get rid of white space to use!

```python title:"Imports & Varible Declarations"
from Crypto.Util.number import *

# Set the values
ciphertext = 54759004599647026122514406856463259157378742086576765421244403681057296667830958496097262677746909468103297432816490414974960025967213693421040371093540798741957150802518404127189506742415632446902481096660685226143139168835776151244118812818745848450316412121438483636074283621696771442062588211105702224797096594284830392179478934633773789319724361281826846525046587704425880624392223072702388140497093800595319096777828899843167601670276914798992771993918276031148033426480942116222001562109013541640188092750398752212726596965440829166079035212641935716410853385684323732317195302607653110572864832832492308614332695688026288520379691225852762946806737257238301231217698751952484355171918946864695694585061331718299798994297433154149373824622985169040067985382226600836882257453757742535197828643434202698460569184108581507634281208686802314678004371660462919488865692183302431661256061955513742244618890434230273318857591946851400449861980175942498279589784406195234672687906617881785093459544645790910945383784867571124154943079571223415398926441026293968354045886500561571326810144583303737574480859608505324180488889170197186871175999271657954999333530291298833058735090465076060239548834720762411779404098209293580868238466921597526031645695700528053632374874845185932714808431370633811502523716823233253451786716629551331404364972256882272398057080620635036019083703322493946834189252061534859326525293003316374735791004880070727032995927925012517689373392639682427582718014579410960338409525830939648282656446532813746549464546747380511872293584924550440836335584666857767951458610836477980076516864059214230403983895530230891408789302306325203234906970983917665145158863889393533463367162504710902317594257056239723173936694745323601923224395095916354161650048792002668682709118545891847039556531344563788200718268073364636546696496449249304700845489683618878058637196637029487619802085884870782067462172988768589896393636504395939721367767239915021596943439462134035647695619496772122726337729191387011155654027977443603283338951893855590636103517011604511158111104893275895159828829025697557539673460337393857004875529156640158439781534266181143797969599285806376638562160457655232891670383782099559129401371578394437360288146260479509996113420815925580470892601019143611638145200265373771650504910779904325868578063492818604204326923531004660704531023499416374365214282656114536666455627295115405857300937775736555543797882713184445755824314743287083

p = 752756528841875537911878995753042707647403949554360208367234877025624409540203682761921093915508418655852799100141664622335039455920022213609629067262019404612608900257336038659394515010131767517305770031660647162848609109822750643234640501869740955176655922145570708435217100522986867976006579678556886154064634200401859738311135275046545253349948244695029660140086807289271141101862789519751792359117649145998563961368942821022739792392716620716795592972055314693267400368927621775645833555066476806996288903284102193917193424100068717536343788993196099054983601286805432602788326469869468644448618558376266945936822260704639989072737441301312016573245856870596451013862168846041144962976913828840204703903519058925554216678932337578982416183815574423593903203140061821312979288304894805529113548445359754020916457961543405670043499378618149742163277100368075376976838192481235095913624354114215289486427358337371249645934091262158698478769080944913191018283682299227448548572620178211758775226399248736351823883253425428859608839822967748417750750768678997191631591453855893210333524224040810300416007274952248435723849035137713609019261006737832050925751968653488941495762445378969236893490220931960617082372175080757226428538037

q = 880398969251452887308660917504486182562846904076287121291763168719274136746566491678268037510905591990771798869782714420383346558397372393848950944120645649208321456758294667377506618947318155191556866564510660193561519685221217401809653517643739084470712009338319620153911750948178187377988580670621276663435429513039194166524665848331078509242778461325908028625612645176647057551931509423846025480365963513278356214803825583621656344773968156935822116713294271209716208332966958714033498575400100929432657699444697408341784580190674105709745459315906374144815643729066799108493717417753626735266610965158888422349537481792575479701428877195230383568296602594553805793662138189357884360599766137250987445388558207947305949875916134750004434379767332412127692481777269654899411040863041093873128187130822708039864773659377990453077182559620579273207601721543020232868137483373438109337018806333516965007507716183075768926336370269493707028653198744031420944067462865900096247705191920717575149703524335706216759290920064723973507925674189242744371890566278426602689696896442712046610306732798031648865549772061987449249681612534599958604135136995325790860158962960039727556175624948552406762985831640742320290062631120287472335619521

e = 65537
```

2. Now solve for <font color="#ff0000">n</font>.

```Python
# Calculate n
n = p * q
```

3. Solve for <font color="#ff0000">$φ(n)$</font>﻿.

```Python
# Calculate phi(n)
phi_n = (p-1)*(q-1)
```

4. Solve the <font color="#ff0000">modular multiplicative inverse</font>.

```Python
# Calculate the modular inverse of e mod phi(n)
d = inverse(e, phi_n)
```

5. Decrypt the message using <font color="#ff0000">private key d and n</font>. Also, convert the output value to bytes to see plaintext!

```Python
# Decrypt the ciphertext
plaintext = long_to_bytes(power_mod(ciphertext, d, n))

# Print the decrypted plaintext
print(plaintext)
```

6. Get FLAG!!!!!
> [!Success] Flag
>b'PCTF{I_H0P3_U_U53D_0CR!}'

```python fold title:"All Code"
from Crypto.Util.number import *

# Set the values
ciphertext = 54759004599647026122514406856463259157378742086576765421244403681057296667830958496097262677746909468103297432816490414974960025967213693421040371093540798741957150802518404127189506742415632446902481096660685226143139168835776151244118812818745848450316412121438483636074283621696771442062588211105702224797096594284830392179478934633773789319724361281826846525046587704425880624392223072702388140497093800595319096777828899843167601670276914798992771993918276031148033426480942116222001562109013541640188092750398752212726596965440829166079035212641935716410853385684323732317195302607653110572864832832492308614332695688026288520379691225852762946806737257238301231217698751952484355171918946864695694585061331718299798994297433154149373824622985169040067985382226600836882257453757742535197828643434202698460569184108581507634281208686802314678004371660462919488865692183302431661256061955513742244618890434230273318857591946851400449861980175942498279589784406195234672687906617881785093459544645790910945383784867571124154943079571223415398926441026293968354045886500561571326810144583303737574480859608505324180488889170197186871175999271657954999333530291298833058735090465076060239548834720762411779404098209293580868238466921597526031645695700528053632374874845185932714808431370633811502523716823233253451786716629551331404364972256882272398057080620635036019083703322493946834189252061534859326525293003316374735791004880070727032995927925012517689373392639682427582718014579410960338409525830939648282656446532813746549464546747380511872293584924550440836335584666857767951458610836477980076516864059214230403983895530230891408789302306325203234906970983917665145158863889393533463367162504710902317594257056239723173936694745323601923224395095916354161650048792002668682709118545891847039556531344563788200718268073364636546696496449249304700845489683618878058637196637029487619802085884870782067462172988768589896393636504395939721367767239915021596943439462134035647695619496772122726337729191387011155654027977443603283338951893855590636103517011604511158111104893275895159828829025697557539673460337393857004875529156640158439781534266181143797969599285806376638562160457655232891670383782099559129401371578394437360288146260479509996113420815925580470892601019143611638145200265373771650504910779904325868578063492818604204326923531004660704531023499416374365214282656114536666455627295115405857300937775736555543797882713184445755824314743287083

p = 752756528841875537911878995753042707647403949554360208367234877025624409540203682761921093915508418655852799100141664622335039455920022213609629067262019404612608900257336038659394515010131767517305770031660647162848609109822750643234640501869740955176655922145570708435217100522986867976006579678556886154064634200401859738311135275046545253349948244695029660140086807289271141101862789519751792359117649145998563961368942821022739792392716620716795592972055314693267400368927621775645833555066476806996288903284102193917193424100068717536343788993196099054983601286805432602788326469869468644448618558376266945936822260704639989072737441301312016573245856870596451013862168846041144962976913828840204703903519058925554216678932337578982416183815574423593903203140061821312979288304894805529113548445359754020916457961543405670043499378618149742163277100368075376976838192481235095913624354114215289486427358337371249645934091262158698478769080944913191018283682299227448548572620178211758775226399248736351823883253425428859608839822967748417750750768678997191631591453855893210333524224040810300416007274952248435723849035137713609019261006737832050925751968653488941495762445378969236893490220931960617082372175080757226428538037

q = 880398969251452887308660917504486182562846904076287121291763168719274136746566491678268037510905591990771798869782714420383346558397372393848950944120645649208321456758294667377506618947318155191556866564510660193561519685221217401809653517643739084470712009338319620153911750948178187377988580670621276663435429513039194166524665848331078509242778461325908028625612645176647057551931509423846025480365963513278356214803825583621656344773968156935822116713294271209716208332966958714033498575400100929432657699444697408341784580190674105709745459315906374144815643729066799108493717417753626735266610965158888422349537481792575479701428877195230383568296602594553805793662138189357884360599766137250987445388558207947305949875916134750004434379767332412127692481777269654899411040863041093873128187130822708039864773659377990453077182559620579273207601721543020232868137483373438109337018806333516965007507716183075768926336370269493707028653198744031420944067462865900096247705191920717575149703524335706216759290920064723973507925674189242744371890566278426602689696896442712046610306732798031648865549772061987449249681612534599958604135136995325790860158962960039727556175624948552406762985831640742320290062631120287472335619521

e = 65537

# Calculate n
n = p * q

# Calculate phi(n)
phi_n = (p-1)*(q-1)

# Calculate the modular inverse of e mod phi(n)
d = inverse(e, phi_n)

# Decrypt the ciphertext
plaintext = long_to_bytes(power_mod(ciphertext, d, n))

# Print the decrypted plaintext
print(plaintext)
```